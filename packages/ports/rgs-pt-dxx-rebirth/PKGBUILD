# Maintainer: V0rt3x667 <al-g0l@outlook.com>

pkgname=rgs-pt-dxx-rebirth
pkgver=0.59.100.r1473.g47a3df9fa
pkgrel=1
pkgdesc="An enhanced engine to play Descent 1 / Descent 2"
arch=('x86_64')
url="http://www.dxx-rebirth.com/"
license=('GPL3' 'custom:Parallax')
depends=('sdl' 'sdl_mixer' 'mesa' 'physfs')
makedepends=('scons' 'unzip')
source=("$pkgname::git+https://github.com/dxx-rebirth/dxx-rebirth.git")
sha256sums=('SKIP')

pkgver() {
    cd $pkgname
    
    ( set -o pipefail
      git describe --long 2>/dev/null | sed 's/\([^-]*-g\)/r\1/;s/-/./g;s/v//g' ||
      printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
    )
}

build() {
    cd $pkgname
    
    sed -ie "/^PREFIX =/s|/opt/archrgs/ports/$pkgname|/usr/|" SConstruct
    scons sharepath="/opt/archrgs/ports/$pkgname/share"
}

package() {
    cd $pkgname
    
    mkdir -p $pkgdir/opt/archrgs/ports/$pkgname/{bin,docs,share/{,pixmaps,applications}}
    mkdir -p "${pkgdir}/usr/share/licenses/${pkgname}"

    install -m755 ./d1x-rebirth/d1x-rebirth "$pkgdir/opt/archrgs/ports/$pkgname/bin"
    install -m755 ./d2x-rebirth/d2x-rebirth "$pkgdir/opt/archrgs/ports/$pkgname/bin"
    install -m755 ./d1x-rebirth/d1x.ini "$pkgdir/opt/archrgs/ports/$pkgname/bin"
    install -m755 ./d2x-rebirth/d2x.ini "$pkgdir/opt/archrgs/ports/$pkgname/bin"
    
    install -m644 ./d1x-rebirth/d1x-rebirth.xpm "$pkgdir/opt/archrgs/ports/$pkgname/share/pixmaps/"
    install -m644 ./d2x-rebirth/d2x-rebirth.xpm "$pkgdir/opt/archrgs/ports/$pkgname/share/pixmaps/"

    install -m644 ./d1x-rebirth/d1x-rebirth.desktop "$pkgdir/opt/archrgs/ports/$pkgname/share/applications/"
    install -m644 ./d2x-rebirth/d2x-rebirth.desktop "$pkgdir/opt/archrgs/ports/$pkgname/share/applications/"

    cp ./README.md "$pkgdir/opt/archrgs/ports/$pkgname/docs/"
    mv -f ./d1x-rebirth/RELEASE-NOTES.txt "$pkgdir/opt/archrgs/ports/$pkgname/docs/D1X-RELEASE-NOTES.txt"
    mv -f ./d2x-rebirth/RELEASE-NOTES.txt "$pkgdir/opt/archrgs/ports/$pkgname/docs/D2X-RELEASE-NOTES.txt"

    install -m644 ./COPYING.txt "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
} 
